{% extends 'admin/master.html' %}
{% from 'admin/components/page_title.html' import page_title %}

{% block body %}
<div class="container-fluid">
  <h1 class="page-title text-black text-3xl font-semibold mb-3">{{ list_title }} (<span id="words-count">{{ words_with_actions|length }}</span>)</h1>

  <div class="my-3 d-flex gap-2">
    {% if import_url %}
    <button type="button" class="btn btn-primary" data-modal-open="import-modal"><i class="fa fa-upload"></i> Импорт</button>
    {% endif %}
    {% if export_url %}
    <a href="{{ export_url }}" class="btn btn-secondary" download><i class="fa fa-download"></i> Экспорт</a>
    {% else %}
    <button type="button" class="btn btn-secondary" disabled><i class="fa fa-download"></i> Экспорт</button>
    {% endif %}
    {% if import_url %}
    <button type="button" class="btn btn-secondary" data-modal-open="minusate-modal"><i class="fa fa-minus-circle"></i> Минусация</button>
    {% else %}
    <button type="button" class="btn btn-secondary" disabled><i class="fa fa-minus-circle"></i> Минусация</button>
    {% endif %}
  </div>

  {% if import_url %}
  {% include 'admin/components/import_txt_modal.html' with context %}
  {% include 'admin/components/minusate_txt_modal.html' with context %}
  {% include 'admin/components/edit_phrase_modal.html' %}
  {% include 'admin/components/delete_phrase_modal.html' %}
  {% endif %}

  <div class="relative my-3">
    <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400">
      <i class="fa fa-search" aria-hidden="true"></i>
    </div>
    <input type="text" id="word-search" name="q" placeholder="Введите слово для поиска" class="block w-full rounded-lg border border-gray-300 bg-white py-2 pl-10  pr-3 text-sm placeholder-gray-500 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"{% if search_url %} data-search-url="{{ search_url }}"{% endif %}>
  </div>

  <div class="table-responsive">
    <table class="table table-striped table-hover words-list-table table-sm">
      <thead class="table-light">
        <tr>
          <th scope="col">Слово</th>
          <th scope="col">Дата добавления</th>
          <th scope="col" class="text-end" style="width: 8rem;">Действия</th>
        </tr>
      </thead>
      <tbody id="words-tbody">
        {% for word, edit_url, delete_url in words_with_actions %}
        <tr>
          <td>{{ word.phrase }}</td>
          <td>{{ word.created_at }}</td>
          <td class="text-end">
            <button type="button" class="btn btn-sm btn-outline-primary" title="Изменить" data-edit-url="{{ edit_url }}" data-phrase="{{ word.phrase|e }}"><i class="fa fa-pencil"></i></button>
            <button type="button" class="btn btn-sm btn-outline-danger" title="Удалить" data-delete-url="{{ delete_url }}" data-phrase="{{ word.phrase|e }}"><i class="fa fa-trash"></i></button>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="3" class="text-muted text-center py-4">Список пуст</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<style>
.words-list-table { font-size: 0.8125rem; line-height: 1.3; }
.words-list-table th,
.words-list-table td { padding: 0.25rem 0.5rem; vertical-align: middle; }
.words-list-table th { font-weight: 600; white-space: nowrap; }
.words-list-table .btn { margin-left: 0.2rem; padding: 0.15rem 0.35rem; font-size: 0.75rem; }
.words-list-table .btn:first-child { margin-left: 0; }
.search-highlight { background-color: #93c5fd; }
</style>

<script>
(function () {
  document.querySelectorAll("[data-modal-open]").forEach(function (btn) {
    btn.addEventListener("click", function () {
      var id = btn.getAttribute("data-modal-open");
      if (id) document.getElementById(id).classList.remove("hidden");
    });
  });
  document.querySelectorAll("[data-modal-close]").forEach(function (el) {
    el.addEventListener("click", function () {
      var id = el.getAttribute("data-modal-close");
      if (id) document.getElementById(id).classList.add("hidden");
    });
  });
  var wordsTbody = document.getElementById("words-tbody");
  if (wordsTbody) {
    wordsTbody.addEventListener("click", function (e) {
      var editBtn = e.target.closest("button[data-edit-url]");
      if (editBtn) {
        var form = document.getElementById("edit-phrase-form");
        var input = document.getElementById("edit-phrase-input");
        if (form && input) {
          form.action = editBtn.getAttribute("data-edit-url");
          input.value = editBtn.getAttribute("data-phrase") || "";
          document.getElementById("edit-phrase-modal").classList.remove("hidden");
        }
        return;
      }
      var delBtn = e.target.closest("button[data-delete-url]");
      if (delBtn) {
        var form = document.getElementById("delete-phrase-form");
        var message = document.getElementById("delete-phrase-message");
        if (form && message) {
          form.action = delBtn.getAttribute("data-delete-url");
          message.textContent = "Удалить фразу «" + (delBtn.getAttribute("data-phrase") || "") + "» из списка?";
          document.getElementById("delete-phrase-modal").classList.remove("hidden");
        }
      }
    });
  }

  var searchInput = document.getElementById("word-search");
  var searchUrl = searchInput && searchInput.getAttribute("data-search-url");
  if (searchUrl) {
    var tbody = document.getElementById("words-tbody");
    var countEl = document.getElementById("words-count");
    var debounceTimer = null;
    var debounceMs = 300;

    function escapeHtml(s) {
      var div = document.createElement("div");
      div.textContent = s;
      return div.innerHTML;
    }
    function escapeRe(s) {
      return s.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
    }
    function highlightPhrase(phrase, terms) {
      var s = escapeHtml(phrase);
      terms.forEach(function (term) {
        if (!term) return;
        var re = new RegExp(escapeRe(term), "gi");
        s = s.replace(re, "<span class=\"search-highlight\">$&</span>");
      });
      return s;
    }
    function renderRow(word) {
      var phraseHtml = highlightPhrase(word.phrase, window._lastSearchTerms || []);
      var phraseEsc = escapeHtml(word.phrase);
      return "<tr><td>" + phraseHtml + "</td><td>" + escapeHtml(word.created_at) + "</td><td class=\"text-end\">" +
        "<button type=\"button\" class=\"btn btn-sm btn-outline-primary\" title=\"Изменить\" data-edit-url=\"" + escapeHtml(word.edit_url) + "\" data-phrase=\"" + phraseEsc + "\"><i class=\"fa fa-pencil\"></i></button> " +
        "<button type=\"button\" class=\"btn btn-sm btn-outline-danger\" title=\"Удалить\" data-delete-url=\"" + escapeHtml(word.delete_url) + "\" data-phrase=\"" + phraseEsc + "\"><i class=\"fa fa-trash\"></i></button>" +
        "</td></tr>";
    }
    function runSearch() {
      var q = searchInput.value.trim();
      var url = searchUrl + (q ? "?q=" + encodeURIComponent(q) : "");
      fetch(url).then(function (r) { return r.json(); }).then(function (data) {
        window._lastSearchTerms = data.search_terms || [];
        if (data.words.length === 0) {
          tbody.innerHTML = "<tr><td colspan=\"3\" class=\"text-muted text-center py-4\">Список пуст</td></tr>";
        } else {
          tbody.innerHTML = data.words.map(renderRow).join("");
        }
        if (countEl) countEl.textContent = data.words.length;
      });
    }
    searchInput.addEventListener("input", function () {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(runSearch, debounceMs);
    });
  }
})();
</script>
{% endblock %}
