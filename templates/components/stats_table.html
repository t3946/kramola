{% set stats_title = stats_title | default('Статистика') %}
{% set stats_data = stats_data | default([]) %}
{% set stats_form_class = stats_form_class | default('form') %}
{% set stats_empty_message = stats_empty_message | default('Данные не найдены.') %}
{% set stats_first_column_title = stats_first_column_title | default('Строка') %}

<div class="card">
    <h3>{{ stats_title }}</h3>

    <div class="stats-table">
        {% if stats_data %}
            {% set ns = namespace(total_sum=0) %}

            {% for stat_item in stats_data %}
                {% set ns.total_sum = ns.total_sum + stat_item['total'] %}
            {% endfor %}

            <table class="word-stats">
                <thead>
                    <tr>
                        <th>{{ stats_first_column_title }}</th>
                        <th>Количество ({{ ns.total_sum }})</th>
                        <th>Найденные формы (кол-во)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stat_item in stats_data %}
                        {% set phrase_source = stat_item.get('search', {}).get('phrase', {}).get('source') %}

                        <tr>
                            <td>
                                {% if phrase_source == search_source_type.LIST_INAGENTS.value %}
                                    <a href="#">{{ stat_item['search']['phrase']['phrase'] }}</a>
                                {% else %}
                                    {{ stat_item['search']['phrase']['phrase'] }}
                                {% endif %}
                            </td>
                            <td>{{ stat_item['total'] }}</td>
                            <td>
                                {% for form_key, form_item in stat_item['forms'].items() %}
                                    <span class="{{ stats_form_class }}">
                                        {{ form_item['form'] }} ({{ form_item['count'] }})

                                        {% if form_item['pages'] %}
                                            (стр. {{ form_item['pages'] | join(', ') }})
                                        {% endif %}
                                    </span>
                                    {% if not loop.last %}, {% endif %}
                                {% endfor %}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p class="note">{{ stats_empty_message }}</p>
        {% endif %}
    </div>
</div>
