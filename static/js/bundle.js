(function(){"use strict";document.addEventListener("DOMContentLoaded",function(){console.log("DOM загружен, скрипт main.js выполняется.");const s=document.getElementById("uploadForm"),c=document.getElementById("submitButton"),t=document.getElementById("clientErrorMessage"),r=document.getElementById("serverErrorMessage"),u=document.getElementById("source_file"),f=document.getElementById("words_file"),d=document.getElementById("words-textarea"),k=document.querySelectorAll('input[name="predefined_list_keys"]'),b=document.querySelector(".checkbox-group"),$=document.querySelectorAll('input[name="input-method"]'),E=document.getElementById("processingMessage"),v=document.getElementById("loaderIcon"),g=document.getElementById("statusText");document.getElementById("preloader"),s||console.error("ОШИБКА: Элемент uploadForm не найден!"),c||console.error("ОШИБКА: Элемент submitButton не найден!"),u||console.error("ОШИБКА: Элемент sourceFileInput не найден!"),t||console.warn("Предупреждение: clientErrorMessage не найден."),E||console.error("ОШИБКА АСИНХ: Элемент processingMessageDiv не найден!"),v||console.error("ОШИБКА АСИНХ: Элемент loaderIcon не найден!"),g||console.error("ОШИБКА АСИНХ: Элемент statusTextElement не найден!");function T(e,o,i,a,p){t&&(t.textContent=p,t.style.display="block");const n=document.querySelector(o);n&&n.style?n.style.border="2px solid red !important":e&&e.style&&(e.style.border="2px solid red !important"),e&&(e.value="");const l=document.getElementById(i);l&&(l.textContent=a),window.scrollTo(0,0)}function C(){u&&u.style&&(u.style.border="");const e=document.querySelector('button[onclick*="source_file"]');e&&e.style&&(e.style.border=""),f&&f.style&&(f.style.border="");const o=document.querySelector('button[onclick*="words_file"]');o&&o.style&&(o.style.border=""),d&&d.style&&(d.style.border=""),b&&b.style&&(b.style.border="")}function F(){let e=!0;if(!s)return!0;const o=s.getAttribute("action")||"";o.includes("highlight.process");const i=o.includes("footnotes.process");if(u&&u.files.length>0){const a=u.files[0],p=a.name.toLowerCase();let n,l,y;if(i?(n=/\.docx$/i,l="Ошибка: Исходный документ должен быть в формате .docx.",y="Файл: docx | файл не выбран"):(n=/\.docx|\.pdf|\.odt$/i,l="Ошибка: Исходный документ должен быть в формате .docx, .pdf или .odt.",y="Файл: docx, pdf, odt | файл не выбран"),!n.test(p))T(u,'button[onclick*="source_file"]',"source_file_info",y,`${l} Некорректный файл: ${a.name}`),e=!1;else{const h=document.querySelector('button[onclick*="source_file"]');h&&h.style&&(h.style.border="")}}if(f&&f.files.length>0){const a=f.files[0],p=a.name.toLowerCase();let n,l,y;const h=s.getAttribute("action")||"";if(h.includes("highlight.process")||h.includes("highlight.process_async")?(n=/\.docx|\.xlsx$/i,l="Ошибка: Файл со словами должен быть в формате .docx или .xlsx.",y="Файл: docx, excel | файл не выбран"):(n=/\.docx$/i,l="Ошибка: Файл со словами должен быть в формате .docx.",y="Файл: docx | файл не выбран"),!n.test(p))T(f,'button[onclick*="words_file"]',"words_file_info",y,`${l} Некорректный файл: ${a.name}`),e=!1;else{const m=document.querySelector('button[onclick*="words_file"]');m&&m.style&&(m.style.border="")}}return e}function P(){var p;if(console.log("--- validateFields ---"),C(),t&&(t.textContent="",t.style.display="none"),!s||!u)return console.error("Критическая ошибка: uploadForm или sourceFileInput не найдены."),t&&(t.textContent="Ошибка конфигурации страницы. Обновите.",t.style.display="block"),!1;const e=u.files.length>0,o=s.getAttribute("action")||"";console.log(`formAction: ${o}`);const i=o.includes("highlight.process")||o.includes("highlight.process_async"),a=o.includes("footnotes.process");if(console.log(`isHighlightForm: ${i}, isFootnotesForm: ${a}, sourceFileSelected: ${e}`),i){console.log("Форма 'Выделение слов'. Проверка источников слов...");const n=f?f.files.length>0:!1,l=d?d.value.trim().length>0:!1;let y=!1;k&&k.length>0&&k.forEach(m=>{m&&m.checked&&(y=!0)}),console.log(`Найдено чекбоксов: ${k?k.length:0}, выбрано: ${y}`);const h=((p=document.querySelector('input[name="input-method"]:checked'))==null?void 0:p.value)||"file",S=y||h==="file"&&n||h==="text"&&l;if(console.log(`Валидация: sourceFileSelected=${e}, predefinedListSelected=${y}, hasWordsSource=${S}`),!e&&!S){console.log("Ошибка: Не выбран документ и не выбран источник слов."),t&&(t.textContent="Ошибка: Необходимо загрузить исходный документ (.docx, .pdf или .odt) или выбрать готовый список для поиска.",t.style.display="block");const m=document.querySelector('button[onclick*="source_file"]');if(m&&m.style?m.style.border="2px solid red !important":u&&u.style&&(u.style.border="2px solid red !important"),!y&&(h==="file"&&!n||h==="text"&&!l)){if(h==="file"&&!n){const _=document.querySelector('button[onclick*="words_file"]');_&&_.style?_.style.border="2px solid red !important":f&&f.style&&(f.style.border="2px solid red !important")}else h==="text"&&!l&&d&&d.style&&(d.style.border="2px solid red !important");b&&b.style&&(b.style.border="2px solid red !important")}return window.scrollTo(0,0),!1}if(e&&!S){if(t&&(t.textContent="Ошибка: Укажите источник слов - загрузите файл, введите текст или выберите готовый список.",t.style.display="block"),h==="file"&&!n){const m=document.querySelector('button[onclick*="words_file"]');m&&m.style?m.style.border="2px solid red !important":f&&f.style&&(f.style.border="2px solid red !important")}else h==="text"&&!l&&d&&d.style&&(d.style.border="2px solid red !important");return b&&b.style&&(b.style.border="2px solid red !important"),window.scrollTo(0,0),!1}return console.log("Валидация прошла успешно для highlight формы. sourceFileSelected="+e+", hasWordsSource="+S),C(),t&&(t.textContent="",t.style.display="none"),console.log("--- validateFields успешно завершена для highlight ---"),!0}else if(!e){console.log("Ошибка: Исходный документ не выбран.");let n="Ошибка: Необходимо загрузить исходный документ";a?n+=" (.docx).":n+=".",t&&(t.textContent=n,t.style.display="block");const l=document.querySelector('button[onclick*="source_file"]');return l&&l.style?l.style.border="2px solid red !important":u&&u.style&&(u.style.border="2px solid red !important"),window.scrollTo(0,0),!1}return console.log("--- validateFields успешно завершена ---"),!0}u&&u.addEventListener("change",function(){C(),F();const e=document.getElementById("source_file_info");e&&(e.textContent=this.files.length>0?`Файл: ${this.files[0].name}`:"Файл: docx, pdf, odt | файл не выбран")}),f&&f.addEventListener("change",function(){C(),F();const e=document.getElementById("words_file_info");e&&(e.textContent=this.files.length>0?`Файл: ${this.files[0].name}`:"Файл: docx, excel | файл не выбран")}),d&&d.addEventListener("input",()=>{C(),L()}),k.forEach(e=>{e.addEventListener("change",C)}),$.length>0&&$.forEach(e=>{e.addEventListener("change",()=>{C(),M()})});function M(){const e=document.getElementById("file-input"),o=document.getElementById("text-input"),i=document.querySelector('label[for="file-method"]'),a=document.querySelector('label[for="text-method"]'),p=document.querySelector('input[name="input-method"]:checked');if(!p||!e||!o||!i||!a){console.error("Ошибка в toggleInputMethod: один из элементов не найден.");return}p.value==="file"?(e.classList.remove("hidden"),o.classList.add("hidden"),i.classList.add("active"),a.classList.remove("active")):(e.classList.add("hidden"),o.classList.remove("hidden"),i.classList.remove("active"),a.classList.add("active"),d&&L())}function L(){d&&(d.style.height="auto",d.style.height=Math.min(d.scrollHeight,200)+"px")}M(),d&&L();let I=null,x=null;function B(e){r&&r.style&&(r.style.display="none"),t&&(t.textContent=e,t.style.display="block")}function H(){t&&(t.textContent="",t.style.display="none")}function D(e="Ваш файл обрабатывается. Пожалуйста, подождите..."){E&&E.style&&(E.style.display="block"),v&&v.style&&(v.style.display="block"),g&&(g.textContent=e),c&&(c.disabled=!0,c.textContent="Обрабатывается...")}function w(){E&&E.style&&(E.style.display="none"),v&&v.style&&(v.style.display="none"),g&&(g.textContent=""),c&&(c.disabled=!1,c.textContent="Обработать")}function q(e){x&&clearInterval(x),x=setInterval(()=>{fetch(`/highlight/task_status/${e}`).then(o=>o.ok?o.json():o.json().catch(()=>{throw new Error(`Ошибка сервера: ${o.status} ${o.statusText}`)})).then(o=>{g&&(g.textContent=o.status||"Проверка статуса..."),console.log("Task status:",o),o.state==="SUCCESS"?(clearInterval(x),x=null,g&&(g.textContent="Обработка завершена! Перенаправление..."),window.location.href=`/highlight/results?task_id=${e}`):o.state==="FAILURE"?(clearInterval(x),x=null,w(),o.status,window.location.href=`/highlight/results?task_id=${e}`):o.state==="NOT_FOUND"&&(clearInterval(x),x=null,w(),B("Задача не найдена на сервере. Попробуйте снова."))}).catch(o=>{console.error("Ошибка при проверке статуса:",o),clearInterval(x),x=null,w(),B("Не удалось проверить статус задачи: "+o.message)})},3e3)}c&&s?c.addEventListener("click",function(e){if(e.preventDefault(),H(),r&&r.style&&(r.style.display="none"),!P()){console.log("Отправка ПРЕДОТВРАЩЕНА: ошибки валидации полей.");return}if(!F()){console.log("Отправка ПРЕДОТВРАЩЕНА: ошибки расширений файлов.");return}const o=new FormData(s);D(),fetch(s.action,{method:"POST",body:o}).then(i=>{const a=i.headers.get("content-type");return a&&a.indexOf("application/json")!==-1?i.json().then(p=>({ok:i.ok,status:i.status,data:p})):i.text().then(p=>{throw new Error(`Неожиданный ответ сервера (не JSON): ${i.status}. Ответ: ${p.substring(0,200)}...`)})}).then(i=>{const{ok:a,status:p,data:n}=i;if(a&&n.task_id)I=n.task_id,g&&(g.textContent=n.message||"Задача принята, ID: "+I),q(I);else{w();let l="Произошла ошибка.";n&&n.error?l=n.error:p&&(l=`Ошибка сервера: ${p}`),B(l)}}).catch(i=>{console.error("Ошибка при отправке формы:",i),w(),B("Произошла ошибка при отправке запроса: "+i.message)})}):console.error("Не найден submitButton или uploadForm для асинхронной отправки.");const N=new URLSearchParams(window.location.search).get("check_task_id");N&&(I=N,D("Проверяем статус предыдущей задачи..."),q(I)),r&&(r.textContent&&r.textContent.trim()?r.style.display="block":r.style&&(r.style.display="none")),console.log("Все обработчики событий установлены.")});const A={popup:null,popupContent:null,errorDetails:null,closeButton:null,init:function(){this.createPopupElements(),this.closeButton.addEventListener("click",()=>{this.hide()}),this.popup.addEventListener("click",s=>{s.target===this.popup&&this.hide()}),document.addEventListener("keydown",s=>{s.key==="Escape"&&this.popup.style.display==="flex"&&this.hide()})},createPopupElements:function(){if(document.getElementById("error-popup")){this.popup=document.getElementById("error-popup"),this.popupContent=document.getElementById("error-message"),this.errorDetails=document.getElementById("error-details"),this.closeButton=document.getElementById("error-popup-close");return}this.popup=document.createElement("div"),this.popup.id="error-popup",this.popup.className="popup-overlay";const s=document.createElement("div");s.className="popup-container";const c=document.createElement("div");c.className="popup-header";const t=document.createElement("h3");t.textContent="Ошибка",this.closeButton=document.createElement("button"),this.closeButton.id="error-popup-close",this.closeButton.className="popup-close",this.closeButton.innerHTML="&times;",c.appendChild(t),c.appendChild(this.closeButton);const r=document.createElement("div");r.className="popup-content",this.popupContent=document.createElement("div"),this.popupContent.id="error-message",this.popupContent.className="error-message",this.errorDetails=document.createElement("div"),this.errorDetails.id="error-details",this.errorDetails.className="error-details",this.errorDetails.style.display="none",r.appendChild(this.popupContent),r.appendChild(this.errorDetails),s.appendChild(c),s.appendChild(r),this.popup.appendChild(s),document.body.appendChild(this.popup)},show:function(s){this.popup||this.init();let c="",t="";if(typeof s=="string"){c=s;const r=s.split("Ошибка: ");r.length>1&&(c="Произошла ошибка при обработке",t=r[1])}else s instanceof Error?(c="Произошла ошибка при обработке",t=`${s.name}: ${s.message}
${s.stack||""}`):typeof s=="object"&&(c=s.message||"Произошла ошибка при обработке",t=s.error||s.details||JSON.stringify(s,null,2));this.popupContent.textContent=c,t?(this.errorDetails.textContent=t,this.errorDetails.style.display="block"):this.errorDetails.style.display="none",this.popup.style.display="flex",setTimeout(()=>{this.popup.querySelector(".popup-container").classList.add("visible")},10)},hide:function(){this.popup&&(this.popup.querySelector(".popup-container").classList.remove("visible"),setTimeout(()=>{this.popup.style.display="none"},300))}};document.addEventListener("DOMContentLoaded",function(){A.init()})})();
